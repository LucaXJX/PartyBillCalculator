<!DOCTYPE html>
<html lang="zh-Hant">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>智能賬單計算 - PBC聚賬通</title>
    <!-- Ionic CDN -->
    <script
      type="module"
      src="https://cdn.jsdelivr.net/npm/@ionic/core/dist/ionic/ionic.esm.js"
    ></script>
    <script
      nomodule
      src="https://cdn.jsdelivr.net/npm/@ionic/core/dist/ionic/ionic.js"
    ></script>
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/@ionic/core/css/ionic.bundle.css"
    />
    <!-- Font Awesome CDN -->
    <link
      href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css"
      rel="stylesheet"
    />
    <style>
      body {
        background: #f3f4f6;
      }
      .fa {
        vertical-align: middle;
      }
      ion-item ion-label {
        white-space: normal;
        width: 100%;
        word-break: break-all;
      }
      ion-datetime {
        min-width: 0;
        width: 100%;
        flex: 1 1 0%;
      }
      ion-item[lines="none"] {
        align-items: center;
      }
    </style>
  </head>
  <body>
    <ion-app>
      <!-- 頂部導航 -->
      <ion-header>
        <ion-toolbar color="primary">
          <ion-title>
            <img
              src="/img/icon32x32.png"
              alt="logo"
              style="height: 24px; vertical-align: middle; margin-right: 8px"
            />
            PBC聚賬通
          </ion-title>
        </ion-toolbar>
      </ion-header>

      <ion-content fullscreen>
        <ion-card>
          <ion-card-header>
            <ion-card-title>
              <i class="fa fa-calculator text-primary"></i>
              智能賬單計算
            </ion-card-title>
            <ion-card-subtitle
              >簡單輸入，公平分攤，輕鬆搞定每一筆聚會賬單</ion-card-subtitle
            >
          </ion-card-header>
          <ion-card-content>
            <!-- 基本信息 -->
            <ion-item>
              <ion-label position="stacked">聚會名稱</ion-label>
              <ion-input
                id="bill-name"
                placeholder="例如：週末聚餐"
              ></ion-input>
            </ion-item>
            <ion-item>
              <ion-label position="stacked">日期</ion-label>
              <ion-datetime
                id="bill-date"
                display-format="YYYY-MM-DD"
              ></ion-datetime>
            </ion-item>
            <ion-item>
              <ion-label position="stacked">地點</ion-label>
              <ion-input
                id="bill-location"
                placeholder="例如：鼎泰豐"
              ></ion-input>
            </ion-item>
            <ion-item>
              <ion-label position="stacked">小費比例 (%)</ion-label>
              <ion-input
                id="bill-tip"
                type="number"
                min="0"
                max="100"
                placeholder="0"
              ></ion-input>
            </ion-item>

            <!-- 參與者 -->
            <ion-list id="participants-container">
              <ion-list-header>
                <ion-label
                  ><i class="fa fa-users text-primary"></i> 參與者</ion-label
                >
                <ion-button id="add-person-btn" fill="outline" size="small">
                  <i class="fa fa-plus-circle"></i> 添加參與者
                </ion-button>
              </ion-list-header>
              <!-- 參與者項目將由JS動態添加 -->
            </ion-list>

            <!-- 消費項目 -->
            <ion-list id="items-container">
              <ion-list-header>
                <ion-label
                  ><i class="fa fa-shopping-basket text-primary"></i>
                  消費項目</ion-label
                >
                <ion-button id="add-item-btn" fill="outline" size="small">
                  <i class="fa fa-plus-circle"></i> 添加項目
                </ion-button>
              </ion-list-header>
              <!-- 項目將由JS動態添加 -->
            </ion-list>

            <!-- 操作按鈕 -->
            <ion-grid>
              <ion-row>
                <ion-col>
                  <ion-button id="save-draft-btn" expand="block" fill="outline">
                    <i class="fa fa-save"></i> 保存草稿
                  </ion-button>
                </ion-col>
                <ion-col>
                  <ion-button id="calculate-btn" expand="block" color="primary">
                    <i class="fa fa-calculator"></i> 開始計算
                  </ion-button>
                </ion-col>
              </ion-row>
            </ion-grid>
          </ion-card-content>
        </ion-card>

        <!-- 計算結果模態框 -->
        <ion-modal id="result-modal">
          <ion-content>
            <ion-card>
              <ion-card-header color="primary">
                <ion-card-title>
                  <i class="fa fa-check-circle"></i> 計算結果
                </ion-card-title>
                <ion-button id="close-modal-btn" slot="end" fill="clear">
                  <i class="fa fa-times"></i>
                </ion-button>
              </ion-card-header>
              <ion-card-content>
                <!-- 結果內容區域 -->
                <div id="result-content"></div>
              </ion-card-content>
            </ion-card>
          </ion-content>
        </ion-modal>
      </ion-content>

      <ion-footer>
        <ion-toolbar color="dark">
          <ion-title size="small"
            >&copy; 2025 PBC聚賬通. 保留所有權利</ion-title
          >
        </ion-toolbar>
      </ion-footer>
    </ion-app>

    <script type="module">
      // 動態添加參與者
      const participantsContainer = document.getElementById(
        "participants-container"
      );
      let participantCount = 0;
      function getParticipantNames() {
        return [
          ...participantsContainer.querySelectorAll(".participant-input"),
        ].map((input, idx) => input.value || `參與者${idx + 1}`);
      }

      function updateItemParticipants() {
        const participantNames = getParticipantNames();
        itemsContainer.querySelectorAll(".item-row").forEach((row) => {
          const sharedBy = [
            ...row.querySelectorAll(".item-participant:checked"),
          ].map((cb) => cb.value);
          const participantsDiv = row.querySelector(".item-participants");
          participantsDiv.innerHTML = participantNames
            .map(
              (name) => `
      <label style="margin-right:8px;">
        <input type="checkbox" class="item-participant" value="${name}" ${
                sharedBy.includes(name) ? "checked" : ""
              }>
        ${name}
      </label>
    `
            )
            .join("");
        });
      }

      function addParticipant(name = "") {
        participantCount++;
        const item = document.createElement("ion-item");
        item.innerHTML = `
    <ion-label position="stacked">姓名</ion-label>
    <ion-input class="participant-input" placeholder="參與者${participantCount}" value="${name}"></ion-input>
    <ion-button fill="clear" color="danger" class="remove-person-btn" style="margin-left:8px;">
      <i class="fa fa-trash"></i>
    </ion-button>
  `;
        participantsContainer.appendChild(item);
        item.querySelector(".remove-person-btn").onclick = () => {
          participantsContainer.removeChild(item);
          updateItemParticipants();
        };
        item.querySelector(".participant-input").oninput =
          updateItemParticipants;
        updateItemParticipants();
      }

      document.getElementById("add-person-btn").onclick = () =>
        addParticipant();

      // 預設添加兩個參與者
      addParticipant();
      addParticipant();

      // 動態添加消費項目
      const itemsContainer = document.getElementById("items-container");
      let itemCount = 0;
      function addItem(name = "", amount = "", sharedBy = []) {
        itemCount++;
        const participantNames = getParticipantNames();
        const itemRow = document.createElement("ion-item");
        itemRow.classList.add("item-row");
        itemRow.innerHTML = `
          <ion-label position="stacked">項目名稱</ion-label>
          <ion-input class="item-name" placeholder="項目${itemCount}" value="${name}"></ion-input>
          <ion-label position="stacked">金額</ion-label>
          <ion-input class="item-amount" type="number" min="0" placeholder="0" value="${amount}"></ion-input>
          <ion-label position="stacked">分攤人員</ion-label>
          <div class="item-participants">
            ${participantNames
              .map(
                (n) => `
              <label style="margin-right:8px;">
                <input type="checkbox" class="item-participant" value="${n}" ${
                  sharedBy.includes(n) ? "checked" : ""
                }>
                ${n}
              </label>
            `
              )
              .join("")}
          </div>
          <ion-button fill="clear" color="danger" class="remove-item-btn" style="margin-left:8px;">
            <i class="fa fa-trash"></i>
          </ion-button>
        `;
        itemsContainer.appendChild(itemRow);
        itemRow.querySelector(".remove-item-btn").onclick = () => {
          itemsContainer.removeChild(itemRow);
        };
      }
      document.getElementById("add-item-btn").onclick = () => addItem();

      // 預設添加一個消費項目
      addItem();

      // 收集表單資料
      function collectBillData() {
        const name = document.getElementById("bill-name").value;
        const date = document.getElementById("bill-date").value;
        const location = document.getElementById("bill-location").value;
        const tip = parseFloat(document.getElementById("bill-tip").value) || 0;
        const participants = [
          ...participantsContainer.querySelectorAll(".participant-input"),
        ].map((input) => ({
          name: input.value,
        }));
        const items = [...itemsContainer.querySelectorAll(".item-row")].map(
          (row) => ({
            name: row.querySelector(".item-name").value,
            amount: parseFloat(row.querySelector(".item-amount").value) || 0,
            sharedBy: [
              ...row.querySelectorAll(".item-participant:checked"),
            ].map((cb) => cb.value),
          })
        );
        return { name, date, location, tip, participants, items };
      }

      // 計算賬單
      document.getElementById("calculate-btn").onclick = async () => {
        const billData = collectBillData();
        const res = await fetch("/api/calculateBill", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(billData),
        });
        const result = await res.json();
        document.getElementById("result-content").innerHTML =
          renderResult(result);
        document.querySelector("ion-modal#result-modal").present();
      };

      // 保存賬單
      document.getElementById("save-draft-btn").onclick = async () => {
        const billData = collectBillData();
        await fetch("/api/saveBill", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(billData),
        });
        alert("賬單已保存");
      };

      // 關閉結果模態框
      document.getElementById("close-modal-btn").onclick = () => {
        document.querySelector("ion-modal#result-modal").dismiss();
      };

      // 結果渲染
      function renderResult(result) {
        if (!result.details) return "計算失敗或無結果";
        return result.details
          .map((d) => `<div>${d.name}: ${d.amount} 元</div>`)
          .join("");
      }
    </script>
  </body>
</html>
